@import '../layout.html'

@section scripts {

    <script type="text/javascript">

        var model = {}

        var load_invoice = function(callback) {

            http.json.get('/api/invoices/@(context.invoiceid)', null, function (response) {

                model.invoice = ko.mapping.fromJS(response.invoice)

                callback()
            })
        }

        var load_companies = function(callback) {
        
            http.json.post('/api/companies', null, {skip: 0, take: 1000, order: {column: 'name', direction: 'desc'}}, function (response) {

                model.companies = response.companies

                callback()
            })            
        }

        var update_invoice = function() {

            var invoice = ko.mapping.toJS(model.invoice)

            http.json.put('/api/invoices/@(context.invoiceid)', null, invoice, function(result) {
                
                if(result.success) {
                
                    return
                }

                model.errors(result.errors)
            })
        }

        var delete_invoice = function() {
        
            var invoice = ko.mapping.toJS(model.invoice)

            http.json.del('/api/invoices/@(context.invoiceid)', null, invoice, function(result) {

            })            
        }

        var cancel_invoice = function() {
        
            window.location = '/invoices'
        }

        $(document).ready(function () {

            $('.date-picker').datepicker({

                format         : "dd/mm/yyyy",

                todayBtn       : true,

                orientation    : "bottom auto",

                autoclose      : true,

                todayHighlight : true
            })

            $('.numeric').keypress(function (e) {
               
                if(e.which == 46) {

                    if($(e.target).val().indexOf('.') == -1) {
                        
                        return true
                    }
                }

                if (e.which != 8 && e.which != 0 && (e.which < 48 || e.which > 57)) {

                    return false;
                }
            }) 

            model.errors = ko.observableArray([])

            load_companies(function() {

                load_invoice(function() {

                    ko.applyBindings(model)
                })            
            })
        })

    </script>
}


@section container {
    
    <div class="starter-template">

        <h1>update invoice</h1>

    </div>
    
    <div data-bind="foreach: errors">

        <div class="alert alert-danger">

            <span data-bind="text: $data"></span>

        </div>

    </div>

    <div class="col-md-6" data-bind="">

        <div class="form-group">

            <label for='company'>company</label>
            
            <select id='company' class='form-control' data-bind="options        : companies, 

                                                                 optionsText    : 'name', 

                                                                 optionsValue   : 'name', 

                                                                 optionsCaption : 'select...',

                                                                 value          : invoice.company"></select>

        </div>

        <div class="form-group">

            <label for="id">id</label>

            <input id="invoiceid" type='text' class='form-control' data-bind="value: invoice.invoiceid" />

        </div>
                    
        <div class="form-group">

            <label for="created">created</label>

            <input id="created" type='text' readonly class='form-control' data-bind="value: invoice.created" />

        </div>

        <div class="form-group">

            <label for="startdate">start date</label>

            <input id="startdate" type='text' class='date-picker form-control' data-bind="value: invoice.startdate" />

        </div>

        <div class="form-group">

            <label for="enddate">end date</label>
            
            <input id='enddate' type='text' class='date-picker form-control' data-bind="value: invoice.enddate" /><i class="icon-th"></i>

        </div>

        <div class="form-group">

            <label for='comment'>comment</label>

            <textarea id='comment' class='form-control'data-bind="value: invoice.comment" ></textarea>

        </div>

    </div>
    
    <div class="col-md-6">

        <div class="form-group">

            <label for="hours">hours</label>

            <input id='hours' type='text' class='form-control numeric' data-bind="value: invoice.hours" />

        </div>

        <div class="form-group">

            <label for="rate">rate</label>

            <input id='rate' type='text' class='form-control numeric' data-bind="value: invoice.rate" />

        </div>

        <div class="form-group">

            <label for='gstrate'>gst rate</label>

            <input id='gstrate' type='text' class='form-control numeric' data-bind="value: invoice.gstrate" />

        </div>

        <div class="form-group">

            <label for="paid">sent</label>

            <input  id='sent' type='checkbox' class='form-control' data-bind="checked: invoice.sent" />

        </div>

        <div class="form-group">

            <label for="paid">paid</label>

            <input id='paid' type='checkbox' class='form-control' data-bind="checked: invoice.paid" />

        </div>

    </div>
    
    <div class="col-md-6">

        <button type="submit" class="btn btn-default" onclick="update_invoice()">update</button>

        <button type="submit" class="btn btn-default" onclick="delete_invoice()">delete</button>

        <button type="submit" class="btn btn-default" onclick="cancel_invoice()">cancel</button>

    </div>

}